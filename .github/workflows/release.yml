# ~~ Generated by projen. To modify, edit .projenrc.js and run "npx projen".

name: release
on:
  push:
    branches:
      - master
      - release
jobs:
  build-upload-deploy:
    runs-on: ubuntu-latest
    permissions: {}
    env:
      MEDLY_GPR_READ: ${{ secrets.MEDLY_GPR_READ }}
    steps:
      - uses: actions/checkout@v2
      - name: Setup Java
        uses: actions/setup-java@v2
        with:
          java-version: 11
          distribution: adopt
          cache: gradle
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
      - name: Lint & Static code analysis
        run: ./gradlew ktlintCheck detekt
      - name: Build with Gradle
        run: ./gradlew build
      - name: Copy migrations zip and rename it to bundle.zip
        run: find ./migration/build/distributions -name "*.zip" | xargs -I zipfile cp -f zipfile bundle.zip
      - name: Build deployable Bundle containing the serverless file and the jar
        run: find . -name "*-all.jar" | xargs -I jarfile zip -uj bundle.zip jarfile ./infra/*
      - name: Upload artifacts to the common S3 bucket for build artitacts of all services
        uses: medlypharmacy/s3-artifacts-action@master
        with:
          aws_access_key_id: ${{ secrets.S3_BUILD_ARTIFACTS_ACCESS_KEY_ID}}
          aws_secret_access_key: ${{ secrets.S3_BUILD_ARTIFACTS_SECRET_ACCESS_KEY}}
          source_path: ./bundle.zip
      - name: Trigger Dev codepipeline webhook
        uses: medlypharmacy/codepipeline-webhook-action@master
        if: github.ref == 'refs/heads/master'
        with:
          deployment_environment: dev
          codepipeline_webhook_url: ${{ secrets.CODEPIPELINE_WEBHOOK_URL }}
          codepipeline_webhook_secret: ${{ secrets.CODEPIPELINE_WEBHOOK_SECRET }}
      - name: Trigger Test codepipeline webhook
        uses: medlypharmacy/codepipeline-webhook-action@master
        if: github.ref == 'refs/heads/master'
        with:
          deployment_environment: test
          codepipeline_webhook_url: ${{ secrets.CODEPIPELINE_WEBHOOK_URL }}
          codepipeline_webhook_secret: ${{ secrets.CODEPIPELINE_WEBHOOK_SECRET }}
      - name: Generate Event Spec
        uses: docker://asyncapi/github-action-for-generator:2.0.0
        with:
          template: "@asyncapi/html-template@0.9.0"
          filepath: connector/kinesis/spec/asyncapi.yml
          output: event-spec-html
      - name: Upload Event Spec
        uses: medlypharmacy/s3-artifacts-action@master
        if: github.ref == 'refs/heads/master'
        with:
          aws_access_key_id: ${{ secrets.S3_BUILD_ARTIFACTS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.S3_BUILD_ARTIFACTS_SECRET_ACCESS_KEY }}
          aws_s3_bucket_name: ${{ secrets.MEDLY_STATIC_ASSETS_BUCKET }}
          source_path: event-spec-html
          destination_path: event-spec
          resource_type: DIRECTORY
      - name: Upload API Spec
        uses: medlypharmacy/s3-artifacts-action@master
        if: github.ref == 'refs/heads/master'
        with:
          aws_access_key_id: ${{ secrets.S3_BUILD_ARTIFACTS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.S3_BUILD_ARTIFACTS_SECRET_ACCESS_KEY }}
          aws_s3_bucket_name: ${{ secrets.MEDLY_STATIC_ASSETS_BUCKET }}
          source_path: ./api/spec
          destination_path: ${{ secrets.API_SPEC }}
          resource_type: SWAGGER_TO_HTML
      - name: Code Coverage report
        run: ./gradlew codeCoverageReport
      - name: Sonar Scan
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./gradlew sonarqube -Dsonar.login=${{ secrets.SONAR_TOKEN }} -s
      - name: Upload test coverage
        uses: medlypharmacy/s3-artifacts-action@master
        with:
          aws_access_key_id: ${{ secrets.S3_BUILD_ARTIFACTS_ACCESS_KEY_ID}}
          aws_secret_access_key: ${{ secrets.S3_BUILD_ARTIFACTS_SECRET_ACCESS_KEY}}
          aws_s3_bucket_name: medly-dev-test-cases
          source_path: ./build/reports/jacoco/codeCoverageReport/html
          destination_path: ${{ secrets.TEST_COVERAGE}}
          resource_type: DIRECTORY

# ~~ Generated by projen. To modify, edit .projenrc.js and run "npx projen".

name: build
on:
  pull_request: {}
jobs:
  build-upload:
    runs-on: ubuntu-latest
    permissions: {}
    env:
      MEDLY_GPR_READ: ${{ secrets.MEDLY_GPR_READ }}
    steps:
      - uses: actions/checkout@v2
      - name: Setup Java
        uses: actions/setup-java@v2
        with:
          java-version: 11
          distribution: adopt
          cache: gradle
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
      - name: Lint & Static code analysis
        run: ./gradlew ktlintCheck detekt
      - name: Build with Gradle
        run: ./gradlew build
      - name: Copy migrations zip and rename it to bundle.zip
        run: find ./migration/build/distributions -name "*.zip" | xargs -I zipfile cp -f zipfile bundle.zip
      - name: Build deployable Bundle containing the serverless file and the jar
        run: find . -name "*-all.jar" | xargs -I jarfile zip -uj bundle.zip jarfile ./infra/*
      - name: Upload artifacts to the common S3 bucket for build artitacts of all services
        uses: medlypharmacy/s3-artifacts-action@master
        with:
          aws_access_key_id: ${{ secrets.S3_BUILD_ARTIFACTS_ACCESS_KEY_ID}}
          aws_secret_access_key: ${{ secrets.S3_BUILD_ARTIFACTS_SECRET_ACCESS_KEY}}
          source_path: ./bundle.zip
      - name: Code Coverage report
        run: ./gradlew codeCoverageReport
      - name: Sonar Scan
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./gradlew sonarqube -Dsonar.login=${{ secrets.SONAR_TOKEN }} -s
